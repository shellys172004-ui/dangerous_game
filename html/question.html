<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Make Your Choice</title>

<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">

<style>
*{margin:0;padding:0;box-sizing:border-box}
body{
  height:100vh;
  overflow:hidden;
  font-family:'Orbitron',sans-serif;
  background:radial-gradient(circle at top,#0e1a2f,#05070c);
  color:#00fff0;
}

/* BACKGROUND GRID */
.background{
  position:fixed;inset:0;
  background:
    repeating-linear-gradient(0deg,rgba(0,255,255,.06) 0 1px,transparent 1px 36px),
    repeating-linear-gradient(90deg,rgba(0,255,255,.06) 0 1px,transparent 1px 36px);
  animation:grid 12s linear infinite;
  z-index:0;
}
@keyframes grid{to{background-position:0 36px,36px 0}}

/* SPRINKLES */
.sprinkles{position:fixed;inset:0;pointer-events:none;z-index:1}
.sprinkle{
  position:absolute;
  width:4px;height:4px;
  background:#00fff0;
  box-shadow:0 0 12px #00fff0,0 0 30px #00fff0;
  animation:float 6s linear infinite;
}
@keyframes float{
  from{transform:translateY(100vh);opacity:0}
  to{transform:translateY(-10vh);opacity:1}
}

/* UI */
.ui{
  position:relative;
  z-index:3;
  height:100%;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
}
.ui.hidden{display:none}

h2{
  font-size:2.3rem;
  text-shadow:0 0 25px #00fff0;
  margin-bottom:20px;
  animation:floatQ 3s ease-in-out infinite;
}
@keyframes floatQ{50%{transform:translateY(-10px)}}

button{
  padding:14px 40px;
  margin:12px;
  font-family:'Orbitron';
  font-size:1rem;
  border-radius:6px;
  border:none;
  cursor:pointer;
}

/* YES */
#yes{
  background:linear-gradient(135deg,#00fff0,#00b3ff);
  color:#000;
  box-shadow:0 0 40px #00fff0;
}

/* NO (âœ… FIX: start as normal so it shows; we switch to absolute only when dodging) */
#no{
  position:relative;
  background:#ff004c;
  color:#fff;
  box-shadow:0 0 35px #ff004c;
}

/* YES TRANSITION SCREEN (RESTORED) */
.transition{
  position:fixed;inset:0;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  opacity:0;
  pointer-events:none;
  z-index:6;
  transition:opacity .6s ease;
}
.transition.active{opacity:1;pointer-events:auto}

.transition h1{
  font-size:2.2rem;
  text-shadow:0 0 30px #00fff0;
  animation:glitch .25s infinite;
}
@keyframes glitch{
  25%{transform:translate(-2px,2px)}
  50%{transform:translate(2px,-2px)}
}

.transition p{margin-top:12px;opacity:.85}

/* GO BACK BUTTON */
.transition button{
  margin-top:30px;
  background:transparent;
  color:#00fff0;
  border:1px solid #00fff0;
  box-shadow:0 0 25px #00fff0;
}
.transition button:hover{
  background:#00fff0;
  color:#000;
}

/* CRT */
body.crt::before{
  content:'';
  position:fixed;inset:0;
  background:repeating-linear-gradient(
    to bottom,
    rgba(0,0,0,.25) 0,
    rgba(0,0,0,.25) 1px,
    transparent 2px
  );
  pointer-events:none;
  z-index:20;
}
body.crt{animation:jitter .15s infinite}
@keyframes jitter{50%{transform:translate(1px,-1px)}}

/* GLASS */
#glass{position:fixed;inset:0;pointer-events:none;z-index:4}

/* NO MODAL */
.noModal{
  position:fixed;inset:0;
  background:rgba(0,0,0,.85);
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  opacity:0;
  pointer-events:none;
  z-index:7;
}
.noModal.active{opacity:1;pointer-events:auto}

.noModal button{
  background:transparent;
  color:#00fff0;
  border:1px solid #00fff0;
  box-shadow:0 0 30px #00fff0;
}

/* SHARDS */
.shard{
  position:fixed;
  width:30px;height:30px;
  background:#00fff0;
  clip-path:polygon(50% 0%,100% 30%,80% 100%,20% 100%,0% 30%);
  box-shadow:0 0 20px #00fff0,0 0 40px rgba(0,255,240,.9);
  pointer-events:none;
  z-index:8;
}

/* BLUR */
body.blur{
  filter:blur(6px) brightness(.85);
  transition:filter .6s ease;
}

/* OVERLAY */
.tapOverlay{
  position:fixed;
  inset:0;
  z-index:999;
  display:flex;
  align-items:center;
  justify-content:center;
  background:#000;
  cursor:pointer;
}
.tapOverlay.hidden{display:none}

/* âœ… FIX: wrapper for overlay so aura can size + layer correctly */
.overlayWrap{
  position:relative;
  display:inline-block;
  overflow:visible;
  z-index:1000;
}

.tapOverlay span{
  padding:14px 18px;
  border:1px solid #00fff0;
  box-shadow:0 0 30px #00fff0;
  border-radius:10px;
  text-shadow:0 0 18px #00fff0;
  color:#00fff0;
  position:relative;
  z-index:2;
}

/* --- 3-step overlay scaling (same style, bigger each time) --- */
.tapOverlay.step1 span{ font-size:1.05rem; transform:scale(1); }
.tapOverlay.step2 span{ font-size:1.35rem; transform:scale(1.15); }
.tapOverlay.step3 span{ font-size:1.8rem;  transform:scale(1.35); }

/* ===================== AURA BARS ===================== */
.btnWrap{
  position:relative;
  display:inline-block;
  overflow:visible;
}
.btnWrap > button{
  position:relative;
  z-index:2;
}

/* close to element edge */
.aura{
  position:absolute;
  inset:-6px;
  pointer-events:none;
  opacity:0;
  transition:opacity .10s linear;
  z-index:1;
}
.aura.on{ opacity:1; }

.aura .side{
  position:absolute;
  display:flex;
  opacity:.95;
}

.aura .top{
  left:0; right:0; top:0;
  height:0;
  align-items:flex-end;
  justify-content:space-between;
}
.aura .bottom{
  left:0; right:0; bottom:0;
  height:0;
  align-items:flex-start;
  justify-content:space-between;
}
.aura .left{
  top:0; bottom:0; left:0;
  width:0;
  flex-direction:column;
  align-items:flex-end;
  justify-content:space-between;
}
.aura .right{
  top:0; bottom:0; right:0;
  width:0;
  flex-direction:column;
  align-items:flex-start;
  justify-content:space-between;
}

.aura .vbar{
  width:1px;
  height:2px;
  background:#00fff0;
  box-shadow:0 0 10px rgba(0,255,240,.9);
  border-radius:1px;
}
.aura .hbar{
  height:1px;
  width:2px;
  background:#00fff0;
  box-shadow:0 0 10px rgba(0,255,240,.9);
  border-radius:1px;
}
</style>
</head>

<body>

<div class="background"></div>
<div class="sprinkles" id="sprinkles"></div>
<svg id="glass"></svg>

<div class="ui" id="mainUI">
  <h2 id="question">Will you be my valentine?</h2>

  <div class="btnWrap" id="yesWrap">
    <button id="yes">YES</button>
  </div>

  <div class="btnWrap" id="noWrap">
    <button id="no">NO</button>
  </div>
</div>

<div class="transition" id="transition">
  <h1>"yAyAyAyAyAY" ðŸŽ®ðŸ”¥</h1>
  <p>You made the wise choice ðŸ˜ŒðŸ’™</p>
  <button id="back">GO BACK</button>
</div>

<div class="noModal" id="noModal">
  <h2>I know that wasnâ€™t intentional.</h2>
  <button id="apology">Sorry, I meant YES!!!!</button>
</div>

<div class="tapOverlay step1" id="tapOverlay">
  <div class="overlayWrap" id="overlayWrap">
    <span id="tapOverlayText">Click if you really want to enter.</span>
  </div>
</div>

<audio id="heartbeat" src="heartbeat.mp3" loop></audio>
<audio id="glassSound" src="glass.mp3"></audio>
<audio id="happySound" src="happy_happy_happy_cat.mp3"></audio>
<audio id="questionSound" src="question.mp3" loop></audio>

<script>
/* SPRINKLES */
const sprinkles=document.getElementById('sprinkles');
for(let i=0;i<50;i++){
  const s=document.createElement('div');
  s.className='sprinkle';
  s.style.left=Math.random()*100+'%';
  s.style.animationDelay=Math.random()*6+'s';
  sprinkles.appendChild(s);
}

/* ELEMENTS */
const yes=document.getElementById('yes');
const no=document.getElementById('no');
const yesWrap=document.getElementById('yesWrap');
const noWrap=document.getElementById('noWrap');

const mainUI=document.getElementById('mainUI');
const transition=document.getElementById('transition');
const back=document.getElementById('back');
const noModal=document.getElementById('noModal');
const apology=document.getElementById('apology');
const glass=document.getElementById('glass');

const heartbeat=document.getElementById('heartbeat');
const glassSound=document.getElementById('glassSound');
const happySound=document.getElementById('happySound');
const questionSound=document.getElementById('questionSound');

const questionEl=document.getElementById('question');
const tapOverlay=document.getElementById('tapOverlay');
const tapOverlayText=document.getElementById('tapOverlayText');
const overlayWrap=document.getElementById('overlayWrap');

questionSound.volume = 0.6;

let logoutTimer;

/* ===================== AUDIO ANALYSER ===================== */
let audioCtx = null;
let analyser = null;
let dataArr = null;
let sources = new Map();
let currentAudioEl = null;

function ensureAudioVisuals(){
  if(audioCtx) return;
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  analyser = audioCtx.createAnalyser();
  analyser.fftSize = 2048;
  dataArr = new Uint8Array(analyser.frequencyBinCount);
  analyser.connect(audioCtx.destination);
}

function getSourceFor(el){
  if(sources.has(el)) return sources.get(el);
  const src = audioCtx.createMediaElementSource(el);
  sources.set(el, src);
  return src;
}

function setActiveAudio(el){
  if(!audioCtx || !analyser) return;
  if(currentAudioEl === el) return;

  if(currentAudioEl && sources.has(currentAudioEl)){
    try{ sources.get(currentAudioEl).disconnect(); }catch(e){}
  }
  currentAudioEl = el;

  try{
    const src = getSourceFor(el);
    src.connect(analyser);
  }catch(e){}
}
/* ========================================================== */

/* ===================== AURA BUILDER ===================== */
function makeAura(target, topCount=76, sideCount=28){
  const aura=document.createElement('div');
  aura.className='aura';

  const top=document.createElement('div'); top.className='side top';
  const bottom=document.createElement('div'); bottom.className='side bottom';
  const left=document.createElement('div'); left.className='side left';
  const right=document.createElement('div'); right.className='side right';

  const topBars=[], bottomBars=[], leftBars=[], rightBars=[];
  for(let i=0;i<topCount;i++){
    const b=document.createElement('span');
    b.className='vbar';
    const t = i/(topCount-1);
    b.dataset.w = (0.35 + 0.65*Math.sin(Math.PI*t)).toFixed(3);
    top.appendChild(b); topBars.push(b);
  }
  for(let i=0;i<topCount;i++){
    const b=document.createElement('span');
    b.className='vbar';
    const t = i/(topCount-1);
    b.dataset.w = (0.35 + 0.65*Math.sin(Math.PI*t)).toFixed(3);
    bottom.appendChild(b); bottomBars.push(b);
  }
  for(let i=0;i<sideCount;i++){
    const b=document.createElement('span');
    b.className='hbar';
    const t = i/(sideCount-1);
    b.dataset.w = (0.35 + 0.65*Math.sin(Math.PI*t)).toFixed(3);
    left.appendChild(b); leftBars.push(b);
  }
  for(let i=0;i<sideCount;i++){
    const b=document.createElement('span');
    b.className='hbar';
    const t = i/(sideCount-1);
    b.dataset.w = (0.35 + 0.65*Math.sin(Math.PI*t)).toFixed(3);
    right.appendChild(b); rightBars.push(b);
  }

  aura.appendChild(top);
  aura.appendChild(bottom);
  aura.appendChild(left);
  aura.appendChild(right);
  target.appendChild(aura);

  return { aura, topBars, bottomBars, leftBars, rightBars };
}

const yesAura = makeAura(yesWrap);
const noAura  = makeAura(noWrap);
const ovAura  = makeAura(overlayWrap);
/* ========================================================== */

/* ===================== VISUAL LOOP (4-BAR DELAY PATTERN) ===================== */
let visRAF = null;
let smoothLevel = 0;

/* âœ… NEW: 4-phase delayed levels (1st fastest, then increasing delay) */
let phaseLvls = [0,0,0,0];

function setAuraOn(a, on){
  if(on) a.aura.classList.add('on');
  else a.aura.classList.remove('on');
}

function applyAura(a, levelForPhaseIndex){
  const maxV = 78;  // exaggerated
  const maxH = 78;

  // top/bottom bars use phase by index%4
  for(let i=0;i<a.topBars.length;i++){
    const b = a.topBars[i];
    const w = parseFloat(b.dataset.w);
    const lvl = levelForPhaseIndex[i & 3]; // 0..3 pattern
    b.style.height = (2 + lvl * w * maxV) + 'px';
  }
  for(let i=0;i<a.bottomBars.length;i++){
    const b = a.bottomBars[i];
    const w = parseFloat(b.dataset.w);
    const lvl = levelForPhaseIndex[i & 3];
    b.style.height = (2 + lvl * w * maxV) + 'px';
  }

  // side bars also phase by index%4
  for(let i=0;i<a.leftBars.length;i++){
    const b = a.leftBars[i];
    const w = parseFloat(b.dataset.w);
    const lvl = levelForPhaseIndex[i & 3];
    b.style.width = (2 + lvl * w * maxH) + 'px';
  }
  for(let i=0;i<a.rightBars.length;i++){
    const b = a.rightBars[i];
    const w = parseFloat(b.dataset.w);
    const lvl = levelForPhaseIndex[i & 3];
    b.style.width = (2 + lvl * w * maxH) + 'px';
  }
}

function getMusicLevel(){
  analyser.getByteFrequencyData(dataArr);

  const start = 18;
  const end = Math.min(dataArr.length-1, 220);

  let sum = 0, n = 0;
  for(let i=start;i<=end;i++){
    sum += dataArr[i];
    n++;
  }
  let v = (sum / n) / 255;
  v = v * v;
  return v;
}

function updatePhases(target){
  // Fast attack + slow decay for master level
  if(target > smoothLevel){
    smoothLevel += (target - smoothLevel) * 0.35;
  }else{
    smoothLevel *= 0.94;
  }

  // Exaggerate peaks
  const shaped = Math.min(1, Math.pow(smoothLevel, 0.75));

  // âœ… NEW: 4 delay phases â€” increasing lag
  // phase 0 follows quickest, phase 3 slowest
  const a0 = 0.35; // fastest
  const a1 = 0.22;
  const a2 = 0.14;
  const a3 = 0.09; // slowest

  phaseLvls[0] += (shaped - phaseLvls[0]) * a0;
  phaseLvls[1] += (shaped - phaseLvls[1]) * a1;
  phaseLvls[2] += (shaped - phaseLvls[2]) * a2;
  phaseLvls[3] += (shaped - phaseLvls[3]) * a3;

  return shaped;
}

function visualLoop(){
  const playing = analyser && currentAudioEl && !currentAudioEl.paused;

  if(!playing){
    setAuraOn(yesAura,false);
    setAuraOn(noAura,false);
    setAuraOn(ovAura,false);

    smoothLevel *= 0.92;
    for(let i=0;i<4;i++) phaseLvls[i] *= 0.90;

    applyAura(yesAura, [0,0,0,0]);
    applyAura(noAura,  [0,0,0,0]);
    applyAura(ovAura,  [0,0,0,0]);

    visRAF = requestAnimationFrame(visualLoop);
    return;
  }

  const raw = getMusicLevel();
  const shaped = updatePhases(raw);

  const on = shaped > 0.012;
  setAuraOn(yesAura, on);
  setAuraOn(noAura, on);
  setAuraOn(ovAura, on);

  const yesGain = (currentAudioEl === happySound) ? 1.22 : 1.00;
  const noGain  = (currentAudioEl === heartbeat) ? 1.30 : 1.00;

  const yesPh = phaseLvls.map(v => Math.min(1, v * yesGain));
  const noPh  = phaseLvls.map(v => Math.min(1, v * noGain));
  const ovPh  = phaseLvls.slice(); // same

  applyAura(yesAura, yesPh);
  applyAura(noAura,  noPh);
  applyAura(ovAura,  ovPh);

  const qGlow = Math.round(25 + shaped * 95);
  questionEl.style.textShadow = `0 0 ${qGlow}px #00fff0`;

  visRAF = requestAnimationFrame(visualLoop);
}
/* ========================================================== */

/* YES FLOW */
function showYes(){
  clearTimeout(logoutTimer);
  mainUI.classList.add('hidden');
  noModal.classList.remove('active');
  document.body.classList.remove('crt','blur');
  glass.innerHTML='';
  heartbeat.pause();
  questionSound.pause();
  happySound.currentTime = 0;
  setActiveAudio(happySound);
  happySound.play();
  transition.classList.add('active');
}
yes.onclick=showYes;
apology.onclick=showYes;

/* GO BACK */
back.onclick=()=>{
  transition.classList.remove('active');
  mainUI.classList.remove('hidden');
  happySound.pause();
  happySound.currentTime = 0;

  setActiveAudio(questionSound);
  questionSound.play().catch(()=>{});
};

/* NO DODGE (âœ… FIX: make it absolute only when dodging starts, so it shows initially) */
let noActivatedAbsolute = false;
document.addEventListener('mousemove',e=>{
  const r=no.getBoundingClientRect();
  if(Math.hypot(e.clientX-r.left,e.clientY-r.top)<120){

    if(!noActivatedAbsolute){
      noActivatedAbsolute = true;
      no.style.position = 'absolute';
      // anchor it where it currently is, so it doesn't jump weirdly
      const wrapRect = noWrap.getBoundingClientRect();
      const btnRect = r;
      no.style.left = (btnRect.left - wrapRect.left) + 'px';
      no.style.top  = (btnRect.top  - wrapRect.top ) + 'px';
    }

    no.style.left=Math.random()*(innerWidth-120)+'px';
    no.style.top=Math.random()*(innerHeight-60)+'px';
  }
});

/* NO CLICK */
no.onclick=e=>{
  document.body.classList.add('crt');
  noModal.classList.add('active');
  heartbeat.currentTime = 0;
  questionSound.pause();
  setActiveAudio(heartbeat);
  heartbeat.play();
  crackFromCenter(e.clientX,e.clientY);

  logoutTimer=setTimeout(()=>{
    fullShatter();
    setActiveAudio(glassSound);
    glassSound.play();
    polygonShardFall(innerWidth/2,innerHeight/2);
    setTimeout(()=>{
      document.body.classList.add('blur');
      location.href='/private-site/';
    },1600);
  },10000);
};

/* ===== CRACKS (kept as in your file) ===== */
function crackSeed(x, y) {
  for (let i = 0; i < 6; i++) {
    let path = `M ${x} ${y}`;
    let angle = Math.random() * Math.PI * 2;
    let cx = x, cy = y;
    for (let j = 0; j < 8; j++) {
      angle += (Math.random() - 0.5) * 1;
      const len = 50 + Math.random() * 50;
      cx += Math.cos(angle) * len;
      cy += Math.sin(angle) * len;
      path += ` L ${cx} ${cy}`;
    }
    const p = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    p.setAttribute('d', path);
    p.setAttribute('stroke', '#00fff0');
    p.setAttribute('stroke-width', '5');
    p.setAttribute('fill', 'none');
    p.style.filter = 'drop-shadow(0 0 25px #00fff0) drop-shadow(0 0 15px #00fff0)';
    glass.appendChild(p);
  }
}
function crackGrowth() {
  const centerX = window.innerWidth / 2;
  const centerY = window.innerHeight / 2;
  crackSeed(centerX, centerY);
}
growthInterval = setInterval(crackGrowth, 1000);

/* SHARDS (kept as in your file) */
function polygonShardFall(centerX, centerY){
  const shardCount = 90;
  for(let i=0;i<shardCount;i++){
    const f = document.createElement('div');
    f.classList.add('fragment');

    const shapes = [
      'polygon(0 0, 100% 0, 100% 100%, 0 100%)',
      'polygon(0 0, 100% 10%, 90% 100%, 10% 90%)',
      'polygon(0 10%, 100% 0, 90% 100%, 0 90%)',
      'polygon(10% 0, 100% 0, 90% 100%, 0 90%)'
    ];
    f.style.clipPath = shapes[Math.floor(Math.random()*shapes.length)];
    const size = 15 + Math.random()*25;
    f.style.width = size + 'px';
    f.style.height = size + 'px';
    f.style.background = '#00fff0';
    f.style.boxShadow = '0 0 20px #00fff0, 0 0 40px #00fff0';
    f.style.left = centerX + 'px';
    f.style.top = centerY + 'px';
    const dx = (Math.random() - 0.5) * window.innerWidth * (0.8 + Math.random()*0.5);
    const dy = (Math.random() - 0.5) * window.innerHeight * (0.8 + Math.random()*0.5);
    const rot = Math.random()*720-360;
    f.animate(
      [
        {transform: 'translate(0,0) rotate(0deg)', opacity:1},
        {transform: `translate(${dx}px,${dy}px) rotate(${rot}deg)`, opacity:0}
      ],
      {duration:1400 + Math.random()*400, easing:'cubic-bezier(.22,.61,.36,1)', fill:'forwards'}
    );
    document.body.appendChild(f);
    setTimeout(()=>f.remove(),2000);
  }
}

/* SVG ANIM */
const style=document.createElement('style');
style.innerHTML='@keyframes draw{to{stroke-dashoffset:0}}';
document.head.appendChild(style);

/* ---------- TAP TO START AUDIO ---------- */
yes.style.pointerEvents = 'none';
no.style.pointerEvents = 'none';

let overlayStep = 1;
let audioPrimed = false;

function setOverlayStep(step){
  overlayStep = step;
  tapOverlay.classList.remove('step1','step2','step3');
  tapOverlay.classList.add('step'+step);

  if(step===1) tapOverlayText.textContent = "Click if you really want to enter.";
  if(step===2) tapOverlayText.textContent = "You can still turn back.";
  if(step===3) tapOverlayText.textContent = "Enter at your own risk.";
}
setOverlayStep(1);

function primeAudio(a){
  const prevMuted = a.muted;
  a.muted = true;
  const p = a.play();
  if(p && typeof p.then === 'function'){
    p.then(()=>{
      a.pause();
      try{ a.currentTime = 0; }catch(e){}
      a.muted = prevMuted;
    }).catch(()=>{ a.muted = prevMuted; });
  }else{
    a.pause();
    try{ a.currentTime = 0; }catch(e){}
    a.muted = prevMuted;
  }
}

async function unlockAndStartQuestion(){
  ensureAudioVisuals();
  try{ await audioCtx.resume(); }catch(e){}

  if(!visRAF) visualLoop();

  try{
    setActiveAudio(questionSound);
    await questionSound.play();
  }catch(e){
    return;
  }

  if(!audioPrimed){
    audioPrimed = true;
    primeAudio(happySound);
    primeAudio(heartbeat);
    primeAudio(glassSound);
  }

  if(overlayStep < 3){
    setOverlayStep(overlayStep + 1);
    return;
  }

  tapOverlay.classList.add('hidden');
  yes.style.pointerEvents = '';
  no.style.pointerEvents = '';
}

tapOverlay.addEventListener('pointerdown', unlockAndStartQuestion, { passive:true });
</script>

</body>
</html>
